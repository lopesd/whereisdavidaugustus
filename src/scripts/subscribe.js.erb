const subscribeUrl = 'https://www.whereisdavidaugustus.com/api/subscribe_email'
const unsubscribeUrl = 'https://www.whereisdavidaugustus.com/api/unsubscribe_email'

// AJAX CALLS
// helper function to make a fetch call with a json body and response
async function jsonFetch(url, body) {
  const params = {
    method: 'POST',
    mode: 'same-origin',
    cache: 'no-cache',
    credentials: 'same-origin',
    headers: { 'Content-Type': 'application/json' },
    redirect: 'follow',
    referrerPolicy: 'no-referrer',
    body: JSON.stringify(body)
  }
  const resp = await fetch(url, params)
  return await resp.json()
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById('subscribe-button').addEventListener('click', async () => {
    const emailInputEl = document.getElementById('email-input')
    const emailAddress = emailInputEl.value

    if (!emailAddress) {
      emailInputEl.placeholder = 'email is required dummy!'
      return
    }

    let resp
    try {
      resp = await jsonFetch(subscribeUrl, { emailAddress })
    } catch(e) {
      setSubscriptionMessage('error! please let me know!', true)
    }

    console.log(resp)
    if (resp.code === 'success') {
      setSubscriptionMessage("amazing! you're subscribed")
    } else if (resp.code === 'not_found') {
      setSubscriptionMessage("love the enthusiasm but you can't subscribe twice")
    } else {
      setSubscriptionMessage("error! please let me know!", true)
    }
  })

  document.getElementById('unsubscribe-button').addEventListener('click', async () => {
    const emailInputEl = document.getElementById('email-input')
    const emailAddress = emailInputEl.value

    if (!emailAddress) {
      emailInputEl.placeholder = 'email is required dummy!'
      return
    }

    let resp
    try {
      resp = await jsonFetch(unsubscribeUrl, { emailAddress })
    } catch(e) {
      setSubscriptionMessage('error! please let me know!', true)
    }

    console.log(resp)
    if (resp.code === 'success') {
      setSubscriptionMessage('wow ok. unsubscribed')
    } else if (resp.code === 'not_found') {
      setSubscriptionMessage("you weren't subscribed anyway")
    } else {
      setSubscriptionMessage("error! please let me know!", true)
    }
  })
})

function setSubscriptionMessage(msg, error=false) {
  const el = document.getElementById('subscription-message')
  el.innerHTML = msg
  if (error) {
    el.classList.add('error')
  } else {
    el.classList.remove('error')
  }
}